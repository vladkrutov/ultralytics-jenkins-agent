# Ultralytics Jenkins Agent Image

This repository builds a Docker image that combines:

* `ultralytics/ultralytics:latest` as the base image
* Java runtime and Jenkins inbound agent
* A simple entrypoint script that connects the container to a Jenkins controller

The image is built and published to GitHub Container Registry (GHCR) using GitHub Actions.

---

## Image Overview

Base image:

* `ultralytics/ultralytics:latest`

Added components:

* OpenJDK 17 JRE
* `tini` as the init process
* `curl` to download `agent.jar`
* Non root user `jenkins` (UID 1000 by default)
* Startup script `jenkins-agent` that:

  * downloads `agent.jar` from the Jenkins controller if needed
  * starts the inbound agent with configured name and secret

Default work directory inside the container:

* `/home/jenkins/work`

---

## Built Image

The GitHub Actions workflow builds and publishes the image to GHCR under:

```text
ghcr.io/<OWNER>/ultralytics-jenkins-agent:<tag>
```

Examples:

* `ghcr.io/<OWNER>/ultralytics-jenkins-agent:latest`
* `ghcr.io/<OWNER>/ultralytics-jenkins-agent:00.Images`
* `ghcr.io/<OWNER>/ultralytics-jenkins-agent:<git-sha>`

Replace `<OWNER>` with your GitHub username or organization name.

---

## Branch and Workflow

The GitHub Actions workflow is configured to run on pushes to the `00.Images` branch:

* File: `.github/workflows/build-and-push.yml`
* Triggers:

  * `push` to `00.Images` that changes `Dockerfile`, `jenkins-agent`, or the workflow file
  * manual run via `workflow_dispatch`

The workflow:

1. Checks out the repository
2. Logs in to `ghcr.io` using the built in `GITHUB_TOKEN`
3. Builds the image from `Dockerfile`
4. Pushes the image to GHCR with multiple tags

---

## Environment Variables

The container expects these environment variables at runtime:

* `JENKINS_URL`
  URL of the Jenkins controller, for example
  `https://jenkins.example.com`

* `JENKINS_SECRET`
  Secret string generated by Jenkins for this agent node.

* `JENKINS_AGENT_NAME` (optional)
  Name of the agent as defined in Jenkins.
  If not set, the container uses the hostname.

If any required variable is missing, the entrypoint script exits with an error.

---

## Local Build and Test

Build the image locally:

```bash
docker build -t ulta-jenkins-agent:test .
```

Run the container:

```bash
docker run --rm \
  -e JENKINS_URL=https://jenkins.example.com \
  -e JENKINS_SECRET=your-secret-here \
  -e JENKINS_AGENT_NAME=ultralytics-gpu-1 \
  ulta-jenkins-agent:test
```

The container will:

1. Download `agent.jar` from `${JENKINS_URL}/jnlpJars/agent.jar` if it is not present
2. Connect to
   `${JENKINS_URL}/computer/${JENKINS_AGENT_NAME}/jenkins-agent.jnlp`
3. Use `/home/jenkins/work` as the work directory

---

## Jenkins Node Configuration

In Jenkins:

1. Go to **Manage Jenkins** → **Manage Nodes and Clouds**
2. Create a new node
3. Choose **Permanent Agent**
4. Set:

   * Node name: matches `JENKINS_AGENT_NAME`
   * Remote root directory: `/home/jenkins/work`
   * Launch method: **Launch agent by connecting it to the controller** (inbound)

From the node configuration page you can get:

* The agent secret
* The JNLP URL
  The JNLP URL base must match `JENKINS_URL` and the node name

Use these values in the environment variables of the container.

---

## Using the Image in Jenkins Pipelines

Example `agent` block for a declarative pipeline running on Docker (classic Jenkins Docker plugin):

```groovy
pipeline {
  agent {
    docker {
      image 'ghcr.io/<OWNER>/ultralytics-jenkins-agent:latest'
      args '--gpus all'
    }
  }

  stages {
    stage('Train') {
      steps {
        sh 'yolo task=detect mode=train data=data.yaml model=yolov8n.pt'
      }
    }
  }
}
```

In Kubernetes environments you can use this image in a pod template as the main container for GPU training.

---

## GPU Runtime Notes

Because the base image is `ultralytics/ultralytics:latest` with NVIDIA support, you typically need:

* NVIDIA driver on the host
* `nvidia-container-runtime` or similar
* Docker run arguments like `--gpus all` or the corresponding configuration in Kubernetes (resource requests and limits for GPU)

Details depend on your orchestration environment.

---

## Repository Structure

```text
.
├─ Dockerfile           # Builds ultralytics based Jenkins agent image
├─ jenkins-agent        # Entrypoint script that downloads and runs agent.jar
└─ .github/
   └─ workflows/
      └─ build-and-push.yml  # GitHub Actions workflow that builds and pushes image to GHCR
```

---

## License

Apache 2.0.
