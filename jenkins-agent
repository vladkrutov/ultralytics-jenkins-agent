#!/bin/bash
set -e

log() {
  printf '%s | %s\n' "$(date '+%Y-%m-%d %H:%M:%S.%3N')" "$*"
}

if [ -z "$JENKINS_URL" ]; then
  log "JENKINS_URL is required"
  exit 1
fi

if [ -z "$JENKINS_SECRET" ]; then
  log "JENKINS_SECRET is required"
  exit 1
fi

if [ -z "$JENKINS_AGENT_NAME" ]; then
  JENKINS_AGENT_NAME="$(hostname)"
fi

WORK_DIR="/home/jenkins/agent"
AGENT_JAR="${WORK_DIR}/agent.jar"

mkdir -p "$WORK_DIR"

if [ ! -f "$AGENT_JAR" ]; then
  log "Downloading agent.jar from ${JENKINS_URL}"
  curl -fsSL "${JENKINS_URL}/jnlpJars/agent.jar" -o "$AGENT_JAR"
fi

log "Starting agent '${JENKINS_AGENT_NAME}' with webSocket"

exec java \
  -jar "$AGENT_JAR" \
  -url "$JENKINS_URL" \
  -name "$JENKINS_AGENT_NAME" \
  -secret "$JENKINS_SECRET" \
  -webSocket \
  -workDir "$WORK_DIR"