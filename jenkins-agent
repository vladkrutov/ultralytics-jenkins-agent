#!/bin/bash
set -e

if [ -z "$JENKINS_URL" ]; then
  echo "JENKINS_URL is required"
  exit 1
fi

if [ -z "$JENKINS_SECRET" ]; then
  echo "JENKINS_SECRET is required"
  exit 1
fi

if [ -z "$JENKINS_AGENT_NAME" ]; then
  JENKINS_AGENT_NAME="$(hostname)"
fi

AGENT_JAR="/home/jenkins/agent.jar"

if [ ! -f "$AGENT_JAR" ]; then
  echo "Downloading agent.jar from $JENKINS_URL"
  curl -fsSL "$JENKINS_URL/jnlpJars/agent.jar" -o "$AGENT_JAR"
fi

exec java \
  -jar "$AGENT_JAR" \
  -jnlpUrl "$JENKINS_URL/computer/$JENKINS_AGENT_NAME/jenkins-agent.jnlp" \
  -secret "$JENKINS_SECRET" \
  -workDir "/home/jenkins/work"